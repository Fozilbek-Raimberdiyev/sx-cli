<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Build Scheme using SX-CLI</title>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');
        </style>
        <style>
            body {
                font-family: 'Poppins', sans-serif;
                font-optical-sizing: auto;
                font-style: normal;
            }

            [v-cloak] {
                display: none;
            }
        </style>
    </head>

    <body>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.7.7/axios.min.js"
            integrity="sha512-DdX/YwF5e41Ok+AI81HI8f5/5UsoxCVT9GKYZRIzpLxb8Twz4ZwPPX+jQMwMhNQ9b5+zDEefc+dcvQoPWGNZ3g=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        ></script>
        <link
            rel="stylesheet"
            href="https://unpkg.com/primeicons@7.0.0/primeicons.css"
        />
        <link
            href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
            rel="stylesheet"
        />
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
        <script src="https://unpkg.com/primevue/umd/primevue.min.js"></script>
        <script src="https://unpkg.com/@primevue/themes/umd/aura.min.js"></script>
        <div class="container mx-auto h-screen pt-12 px-2" id="app" v-cloak>
            <div
                v-if="isLoading"
                class="absolute top-0 left-0 right-0 bottom-0 flex justify-center items-center z-10 bg-[rgba(0,0,0,0.2)]"
            >
                <p-progress-spinner
                    style="width: 50px; height: 50px"
                    strokeWidth="8"
                    fill="transparent"
                    animationDuration=".5s"
                    aria-label="Custom ProgressSpinner"
                ></p-progress-spinner>
            </div>
            <div class="card">
                <div class="flex justify-end">
                    <p-button
                        type="button"
                        label="Add table"
                        @click="toggleTableModal"
                    >
                        <template #icon>
                            <i class="bx bx-plus"></i>
                        </template>
                    </p-button>
                </div>

                <p-table
                    :reorderableColumns="true"
                    @columnReorder="onColReorder"
                    @rowReorder="onRowReorder"
                    stripedRows
                    removableSort
                    :value="tables"
                    tableStyle="min-width: 50rem"
                >
                    <template #empty>
                        <div
                            class="text-center flex justify-center items-center gap-2"
                        >
                            <i class="bx bx-search-alt"></i>
                            <span>No tables found.</span>
                        </div>
                    </template>
                    <!-- <p-column
                        rowReorder
                        headerStyle="width: 3rem"
                        
                    ></p-column> -->
                    <!-- â„– -->
                    <p-column
                        :reorderableColumn="false"
                        rowReorder
                        header="No."
                    >
                        <template #body="{ index }"> <i class="bx bx-receipt"></i> {{ index + 1 }} </template>
                    </p-column>
                    <p-column sortable field="name" header="Name"></p-column>
                    <p-column
                        sortable
                        field="apiIdSingular"
                        header="Singular"
                    ></p-column>
                    <p-column
                        sortable
                        field="apiIdPlural"
                        header="Plural"
                    ></p-column>
                    <p-column
                        sortable
                        field="groupName"
                        header="Group"
                    ></p-column>
                    <p-column sortable field="relations" header="Relations">
                        <template #body="slotProps">
                            <div
                                v-if="slotProps.data.relations?.filter(
                            (relation) =>
                                relation.relationTable
                        )?.length"
                            >
                                <div
                                    class="flex items-center gap-1 mt-1"
                                    v-for="relation in slotProps.data.relations?.filter(
                                (relation) =>
                                    relation.relationTable ||
                                    relation.relationType
                            )"
                                >
                                    <p-tag
                                        :value="relation.relationType?.name"
                                        severity="info"
                                    ></p-tag>
                                    <i
                                        v-if="relation.relationTable"
                                        class="bx bx-right-arrow-alt"
                                    ></i>
                                    <p-tag
                                        :value="relation.relationTable?.name"
                                        severity="info"
                                    ></p-tag>
                                </div>
                            </div>
                            <div v-else>
                                <p-tag
                                    value="No relations"
                                    severity="warning"
                                ></p-tag>
                            </div>
                        </template>
                    </p-column>
                    <p-column
                        style="width: 4rem"
                        field="actions"
                        header="Actions"
                    >
                        <template #body="{ item, index }">
                            <div class="flex items-center gap-2">
                                <p-button
                                    style="width: 100px"
                                    @click="deleteTable(index)"
                                    size="small"
                                    label="Delete"
                                    severity="danger"
                                    rounded
                                    size="small"
                                >
                                    <template #icon>
                                        <i class="bx bx-trash"></i>
                                    </template>
                                </p-button>
                                <p-button
                                    style="width: 100px"
                                    @click="toggleUpdateTable(index)"
                                    size="small"
                                    label="Edit"
                                    severity="success"
                                    rounded
                                    size="small"
                                >
                                    <template #icon>
                                        <i class="bx bx-edit"></i>
                                    </template>
                                </p-button>
                            </div>
                        </template>
                    </p-column>
                </p-table>
                <div class="flex justify-end mt-8 gap-1" v-if="tables?.length">
                    <p-button
                        label="Reset"
                        @click=""
                        size="small"
                        severity="secondary"
                    >
                        <template #icon>
                            <i class="bx bx-reset"></i>
                        </template>
                    </p-button>
                    <p-button
                        label="Generate scheme"
                        size="small"
                        :loading="isLoading"
                        severity="info"
                        @click="sendTables"
                    >
                        <template #icon>
                            <i class="bx bx-save"></i>
                        </template>
                    </p-button>
                </div>
            </div>

            <!-- table modal -->
            <p-dialog
                v-model:visible="isVisibleTableModal"
                modal
                :header="isClickedUpdateTable ? 'Update table' : 'Create table'"
                :style="{ width: '85rem' }"
            >
                <div class="mt-6">
                    <div class="grid grid-cols-12 gap-5 mb-6">
                        <div class="col-span-6">
                            <div class="flex flex-col gap-2">
                                <label class="font-regular" for="tablename"
                                    >Table name</label
                                >
                                <p-input
                                    size="small"
                                    id="tablename"
                                    v-model="tableFormState.name"
                                    aria-describedby="tablename"
                                />
                            </div>
                        </div>

                        <div class="col-span-6">
                            <div class="flex flex-col gap-2">
                                <label class="font-regular" for="apiidsingular"
                                    >Api ID (singular)</label
                                >
                                <p-input
                                    size="small"
                                    id="apiidsingular"
                                    v-model="tableFormState.apiIdSingular"
                                    aria-describedby="apiidsingular-table"
                                />
                            </div>
                        </div>
                        <div class="col-span-6">
                            <div class="flex flex-col gap-2">
                                <label class="font-regular" for="apiidplural"
                                    >Api ID (plural)</label
                                >
                                <p-input
                                    size="small"
                                    id="apiidplural"
                                    v-model="tableFormState.apiIdPlural"
                                    aria-describedby="apiidplural-table"
                                />
                            </div>
                        </div>
                        <div class="col-span-6">
                            <div class="flex flex-col gap-2">
                                <label class="font-regular" for="groupname"
                                    >Group name(path)</label
                                >
                                <p-input
                                    placeholder="ex: /admin/users"
                                    size="small"
                                    id="groupName"
                                    v-model="tableFormState.groupName"
                                    aria-describedby="groupname"
                                />
                            </div>
                        </div>
                        <div class="col-span-12"></div>
                        <div
                            class="col-span-12 grid grid-cols-12 gap-5 bg-gray-100 p-5 rounded-md relative pb-10"
                            v-for="(relation, index) in tableFormState.relations"
                            :key="index"
                        >
                            <div class="col-span-6">
                                <div class="flex flex-col gap-2">
                                    <label class="font-regular" for="relation"
                                        >Relation type</label
                                    >
                                    <p-select
                                        id="relation"
                                        size="small"
                                        v-model="relation.relationType"
                                        checkmark
                                        :options="relationTypes"
                                        :optionLabel="(relation) => relation.name"
                                        :optionValue="(relation) => relation.code"
                                        placeholder="Select relation type"
                                        aria-describedby="relation"
                                    >
                                        <template #option="slotProps">
                                            <div class="flex items-center">
                                                <div>
                                                    {{ slotProps.option.name }}
                                                </div>
                                            </div>
                                        </template>
                                        <template #value="slotProps">
                                            <div
                                                v-if="slotProps.value"
                                                class="flex items-center"
                                            >
                                                <div>
                                                    {{ slotProps.value.name }}
                                                </div>
                                            </div>
                                        </template>
                                    </p-select>
                                </div>
                            </div>
                            <div class="col-span-6">
                                <div class="flex flex-col gap-2">
                                    <label class="font-regular" for="tablename"
                                        >Relation table</label
                                    >
                                    <p-select
                                        checkmark
                                        id="tablename"
                                        :optionLabel="(table) => table.name"
                                        :optionValue="(table) => table.name"
                                        size="small"
                                        v-model="relation.relationTable"
                                        :options="tables"
                                        placeholder="Select table"
                                        aria-describedby="tablename"
                                    >
                                        <template #option="slotProps">
                                            <div class="flex items-center">
                                                <div>
                                                    {{ slotProps.option.name }}
                                                </div>
                                            </div>
                                        </template>
                                        <template #value="slotProps">
                                            <div
                                                v-if="slotProps.value"
                                                class="flex items-center"
                                            >
                                                <div>
                                                    {{ slotProps.value.name }}
                                                </div>
                                            </div>
                                        </template>
                                    </p-select>
                                </div>
                            </div>
                            <div class="add-button absolute right-1 top-1">
                                <button
                                    class="p-1 bg-gray-100 rounded-md"
                                    @click="tableFormState.relations.splice(index, 1)"
                                    type="button"
                                >
                                    <i
                                        class="bx bx-x cursor-pointer text-lg text-red-500"
                                    ></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-span-12">
                            <div class="flex justify-end">
                                <button
                                    class="p-1 bg-gray-100 rounded-md"
                                    @click="tableFormState.relations.push({relationType: null, relationTable: null})"
                                    type="button"
                                >
                                    <i
                                        class="bx bx-plus cursor-pointer text-lg text-green-500"
                                    ></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <divider></divider>
                    <div class="flex justify-end">
                        <p-button
                            @click="createField"
                            severity="contrast"
                            type="button"
                            label="Create field"
                        >
                            <template #icon>
                                <i class="bx bx-plus"></i>
                            </template>
                        </p-button>
                    </div>
                    <div class="flex flex-col gap-5 mt-5">
                        <div
                            class="grid grid-cols-12 items-center gap-5"
                            v-for="(field, index) in tableFormState.fields"
                            :key="index"
                        >
                            <div class="col-span-3">
                                <div class="flex flex-col gap-2">
                                    <label class="font-regular" for="fieldname"
                                        >Field name</label
                                    >
                                    <p-input
                                        size="small"
                                        id="fieldname"
                                        v-model="field.name"
                                        aria-describedby="fieldname"
                                    />
                                </div>
                            </div>
                            <div class="col-span-3">
                                <div class="flex flex-col gap-2">
                                    <label for="fieldname"
                                        >Select the type of the field</label
                                    >
                                    <p-select
                                        editable
                                        :options="migrationTypes"
                                        placeholder="Select field type"
                                        style="height: 40px"
                                        v-model="field.type"
                                        aria-describedby="field type"
                                    >
                                    </p-select>
                                </div>
                            </div>
                            <div class="col-span-1">
                                <div class="flex flex-col gap-2">
                                    <label for="nullable">Nullable</label>
                                    <p-toggle-switch
                                        type="text"
                                        id="nullable"
                                        v-model="field.isNullable"
                                        aria-describedby="isNullable"
                                    />
                                </div>
                            </div>
                            <div class="col-span-3">
                                <div class="flex flex-col gap-2">
                                    <label
                                        class="font-regular"
                                        for="validationRules"
                                        >Validation rules</label
                                    >
                                    <p-input
                                        size="small"
                                        id="validationRules"
                                        v-model="field.validationRules"
                                        aria-describedby="validation rules"
                                    />
                                </div>
                            </div>
                            <div class="col-span-2">
                                <div class="flex flex-col gap-2">
                                    <label class="font-regular">Actions</label>
                                    <div class="flex gap-1">
                                        <p-button
                                            @click="deleteField(index)"
                                            class="w-full"
                                            type="button"
                                            label="Delete"
                                            severity="danger"
                                        >
                                            <template #icon>
                                                <i class="bx bx-trash"></i>
                                            </template>
                                        </p-button>
                                        <p-button
                                            @click="resetField(index)"
                                            class="w-full"
                                            type="button"
                                            label="Reset"
                                            severity="warning"
                                        >
                                            <template #icon>
                                                <i class="bx bx-refresh"></i>
                                            </template>
                                        </p-button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end gap-2 mt-4">
                        <p-button
                            size="small"
                            type="button"
                            severity="secondary"
                            label="Reset"
                        >
                            <template #icon>
                                <i class="bx bx-reset"></i>
                            </template>
                        </p-button>
                        <p-button
                            v-if="isClickedUpdateTable"
                            size="small"
                            type="button"
                            label="Update"
                            @click="updateTable"
                        >
                            <template #icon>
                                <i class="bx bx-save"></i>
                            </template>
                        </p-button>
                        <p-button
                            @click="addTable"
                            severity="info"
                            v-else
                            size="small"
                            type="button"
                            label="Save"
                        >
                            <template #icon>
                                <i class="bx bx-save"></i>
                            </template>
                        </p-button>
                    </div>
                </div>
            </p-dialog>
        </div>
        <script type="module">
            const { createApp, ref, onMounted, reactive } = Vue
            const app = createApp({
                setup() {
                    const toast = PrimeVue.useToast()
                    const tables = ref([
                        {
                            name: 'Country',
                            apiIdSingular: 'country',
                            apiIdPlural: 'countries',
                            groupName: '',
                            relations: [
                                {
                                    relationType: null,
                                    relationTable: null,
                                    isOneToMany: false,
                                    isManyToMany: false,
                                    isParent: true,
                                    isChild: false,
                                    parent: {
                                        name: 'Country',
                                        apiIdSingular: 'country',
                                        apiIdPlural: 'countries',
                                        groupName: '',
                                        method: 'hasMany',
                                    },
                                    child: {
                                        method: 'belongsTo',
                                    },
                                },
                            ],
                            fields: [
                                {
                                    name: 'title',
                                    type: 'string',
                                    validationRules: 'required',
                                    isNullable: false,
                                },
                            ],
                            gropName: '',
                        },
                        {
                            name: 'Like',
                            apiIdSingular: 'like',
                            apiIdPlural: 'likes',
                            groupName: '',
                            relations: [
                                {
                                    relationType: null,
                                    relationTable: null,
                                    isOneToMany: false,
                                    isManyToMany: false,
                                    isParent: true,
                                    isChild: false,
                                    parent: {
                                        name: 'Like',
                                        apiIdSingular: 'like',
                                        apiIdPlural: 'likes',
                                        groupName: '',
                                        method: 'hasMany',
                                    },
                                    child: {
                                        method: 'belongsTo',
                                    },
                                },
                                {
                                    relationType: {
                                        name: 'One to Many',
                                        code: 'one-to-many',
                                    },
                                    relationTable: {
                                        name: 'Post',
                                        apiIdSingular: 'post',
                                        apiIdPlural: 'posts',
                                        groupName: '',
                                        child: {
                                            name: 'Like',
                                            apiIdSingular: 'like',
                                            apiIdPlural: 'likes',
                                            groupName: '',
                                        },
                                        parent: {
                                            name: 'Post',
                                            apiIdSingular: 'post',
                                            apiIdPlural: 'posts',
                                            groupName: '',
                                        },
                                        isOneToMany: true,
                                        isManyToMany: false,
                                        isChild: true,
                                        isParent: false,
                                    },
                                },
                            ],
                            fields: [],
                            gropName: '',
                        },
                        {
                            name: 'Comment',
                            apiIdSingular: 'comment',
                            apiIdPlural: 'comments',
                            groupName: '',
                            relations: [
                                {
                                    relationType: null,
                                    relationTable: null,
                                    isOneToMany: false,
                                    isManyToMany: false,
                                    isParent: true,
                                    isChild: false,
                                    parent: {
                                        name: 'Comment',
                                        apiIdSingular: 'comment',
                                        apiIdPlural: 'comments',
                                        groupName: '',
                                        method: 'hasMany',
                                    },
                                    child: {
                                        method: 'belongsTo',
                                    },
                                },
                                {
                                    relationType: {
                                        name: 'One to Many',
                                        code: 'one-to-many',
                                    },
                                    relationTable: {
                                        name: 'Post',
                                        apiIdSingular: 'post',
                                        apiIdPlural: 'posts',
                                        groupName: '',
                                        child: {
                                            name: 'Comment',
                                            apiIdSingular: 'comment',
                                            apiIdPlural: 'comments',
                                            groupName: '',
                                        },
                                        parent: {
                                            name: 'Post',
                                            apiIdSingular: 'post',
                                            apiIdPlural: 'posts',
                                            groupName: '',
                                        },
                                        isOneToMany: true,
                                        isManyToMany: false,
                                        isChild: true,
                                        isParent: false,
                                    },
                                },
                            ],
                            fields: [
                                {
                                    name: 'title',
                                    type: 'longText',
                                    validationRules: '',
                                    isNullable: true,
                                },
                            ],
                            gropName: '',
                        },
                        {
                            name: 'Post',
                            apiIdSingular: 'post',
                            apiIdPlural: 'posts',
                            groupName: '',
                            relations: [
                                {
                                    relationType: {
                                        name: 'One to Many',
                                        code: 'one-to-many',
                                    },
                                    relationTable: {
                                        name: 'Comment',
                                        apiIdSingular: 'comment',
                                        apiIdPlural: 'comments',
                                        groupName: '',
                                        relations: [
                                            {
                                                relationType: null,
                                                relationTable: null,
                                                isOneToMany: false,
                                                isManyToMany: false,
                                                isParent: true,
                                                isChild: false,
                                                parent: {
                                                    name: 'Comment',
                                                    apiIdSingular: 'comment',
                                                    apiIdPlural: 'comments',
                                                    groupName: '',
                                                    method: 'hasMany',
                                                },
                                                child: {
                                                    method: 'belongsTo',
                                                },
                                            },
                                            {
                                                relationType: {
                                                    name: 'One to Many',
                                                    code: 'one-to-many',
                                                },
                                                relationTable: {
                                                    name: 'Post',
                                                    apiIdSingular: 'post',
                                                    apiIdPlural: 'posts',
                                                    groupName: '',
                                                    child: {
                                                        name: 'Comment',
                                                        apiIdSingular:
                                                            'comment',
                                                        apiIdPlural: 'comments',
                                                        groupName: '',
                                                    },
                                                    parent: {
                                                        name: 'Post',
                                                        apiIdSingular: 'post',
                                                        apiIdPlural: 'posts',
                                                        groupName: '',
                                                    },
                                                    isOneToMany: true,
                                                    isManyToMany: false,
                                                    isChild: true,
                                                    isParent: false,
                                                },
                                            },
                                        ],
                                        fields: [
                                            {
                                                name: 'title',
                                                type: 'longText',
                                                validationRules: '',
                                                isNullable: true,
                                            },
                                        ],
                                        gropName: '',
                                    },
                                    isOneToMany: true,
                                    isManyToMany: false,
                                    isParent: true,
                                    isChild: false,
                                    parent: {
                                        name: 'Post',
                                        apiIdSingular: 'post',
                                        apiIdPlural: 'posts',
                                        groupName: '',
                                    },
                                    child: {
                                        name: 'Comment',
                                        apiIdSingular: 'comment',
                                        apiIdPlural: 'comments',
                                        groupName: '',
                                    },
                                },
                                {
                                    relationType: {
                                        name: 'One to Many',
                                        code: 'one-to-many',
                                    },
                                    relationTable: {
                                        name: 'Like',
                                        apiIdSingular: 'like',
                                        apiIdPlural: 'likes',
                                        groupName: '',
                                        relations: [
                                            {
                                                relationType: null,
                                                relationTable: null,
                                                isOneToMany: false,
                                                isManyToMany: false,
                                                isParent: true,
                                                isChild: false,
                                                parent: {
                                                    name: 'Like',
                                                    apiIdSingular: 'like',
                                                    apiIdPlural: 'likes',
                                                    groupName: '',
                                                    method: 'hasMany',
                                                },
                                                child: {
                                                    method: 'belongsTo',
                                                },
                                            },
                                            {
                                                relationType: {
                                                    name: 'One to Many',
                                                    code: 'one-to-many',
                                                },
                                                relationTable: {
                                                    name: 'Post',
                                                    apiIdSingular: 'post',
                                                    apiIdPlural: 'posts',
                                                    groupName: '',
                                                    child: {
                                                        name: 'Like',
                                                        apiIdSingular: 'like',
                                                        apiIdPlural: 'likes',
                                                        groupName: '',
                                                    },
                                                    parent: {
                                                        name: 'Post',
                                                        apiIdSingular: 'post',
                                                        apiIdPlural: 'posts',
                                                        groupName: '',
                                                    },
                                                    isOneToMany: true,
                                                    isManyToMany: false,
                                                    isChild: true,
                                                    isParent: false,
                                                },
                                            },
                                        ],
                                        fields: [],
                                        gropName: '',
                                    },
                                    isOneToMany: true,
                                    isManyToMany: false,
                                    parent: {
                                        name: 'Post',
                                        apiIdSingular: 'post',
                                        apiIdPlural: 'posts',
                                        groupName: '',
                                    },
                                    child: {
                                        name: 'Like',
                                        apiIdSingular: 'like',
                                        apiIdPlural: 'likes',
                                        groupName: '',
                                    },
                                    isParent: true,
                                    isChild: false,
                                },
                            ],
                            fields: [
                                {
                                    name: 'title',
                                    type: 'longText',
                                    validationRules: 'required',
                                    isNullable: false,
                                },
                                {
                                    name: 'description',
                                    type: 'longText',
                                    validationRules: 'required',
                                    isNullable: false,
                                },
                                {
                                    name: 'content',
                                    type: 'longText',
                                    validationRules: 'required',
                                    isNullable: false,
                                },
                            ],
                        },
                        {
                            name: 'Skill',
                            apiIdSingular: 'skill',
                            apiIdPlural: 'skills',
                            groupName: '',
                            relations: [
                                {
                                    relationType: {
                                        name: 'Many to Many',
                                        code: 'many-to-many',
                                    },
                                    relationTable: {
                                        name: 'Developer',
                                        apiIdSingular: 'developer',
                                        apiIdPlural: 'developers',
                                        groupName: '',
                                        relations: [
                                            {
                                                relationType: null,
                                                relationTable: null,
                                                isOneToMany: false,
                                                isManyToMany: false,
                                                isParent: true,
                                                isChild: false,
                                                parent: {
                                                    name: 'Developer',
                                                    apiIdSingular: 'developer',
                                                    apiIdPlural: 'developers',
                                                    groupName: '',
                                                    method: 'hasMany',
                                                },
                                                child: {
                                                    method: 'belongsTo',
                                                },
                                            },
                                            {
                                                relationType: {
                                                    name: 'Many to Many',
                                                    code: 'many-to-many',
                                                },
                                                relationTable: {
                                                    name: 'Skill',
                                                    apiIdSingular: 'skill',
                                                    apiIdPlural: 'skills',
                                                    groupName: '',
                                                },
                                                child: {
                                                    name: 'Developer',
                                                    apiIdSingular: 'developer',
                                                    apiIdPlural: 'developers',
                                                    groupName: '',
                                                    method: 'belongsTo',
                                                },
                                                parent: {
                                                    name: 'Skill',
                                                    apiIdSingular: 'skill',
                                                    apiIdPlural: 'skills',
                                                    groupName: '',
                                                    method: 'hasMany',
                                                },
                                                isOneToMany: false,
                                                isManyToMany: true,
                                                isChild: true,
                                                isParent: false,
                                            },
                                        ],
                                        fields: [
                                            {
                                                name: 'fullName',
                                                type: 'string',
                                                validationRules: 'required',
                                                isNullable: false,
                                            },
                                        ],
                                    },
                                    isOneToMany: false,
                                    isManyToMany: true,
                                    isParent: true,
                                    isChild: false,
                                    parent: {
                                        name: 'Skill',
                                        apiIdSingular: 'skill',
                                        apiIdPlural: 'skills',
                                        groupName: '',
                                        method: 'hasMany',
                                    },
                                    child: {
                                        name: 'Developer',
                                        apiIdSingular: 'developer',
                                        apiIdPlural: 'developers',
                                        groupName: '',
                                        method: 'belongsTo',
                                    },
                                },
                            ],
                            fields: [
                                {
                                    name: 'title',
                                    type: 'string',
                                    validationRules: 'required',
                                    isNullable: false,
                                },
                            ],
                            gropName: '',
                        },
                        {
                            name: 'Developer',
                            apiIdSingular: 'developer',
                            apiIdPlural: 'developers',
                            groupName: '',
                            relations: [
                                {
                                    relationType: null,
                                    relationTable: null,
                                    isOneToMany: false,
                                    isManyToMany: false,
                                    isParent: true,
                                    isChild: false,
                                    parent: {
                                        name: 'Developer',
                                        apiIdSingular: 'developer',
                                        apiIdPlural: 'developers',
                                        groupName: '',
                                        method: 'hasMany',
                                    },
                                    child: {
                                        method: 'belongsTo',
                                    },
                                },
                                {
                                    relationType: {
                                        name: 'Many to Many',
                                        code: 'many-to-many',
                                    },
                                    relationTable: {
                                        name: 'Skill',
                                        apiIdSingular: 'skill',
                                        apiIdPlural: 'skills',
                                        groupName: '',
                                    },
                                    child: {
                                        name: 'Developer',
                                        apiIdSingular: 'developer',
                                        apiIdPlural: 'developers',
                                        groupName: '',
                                        method: 'belongsTo',
                                    },
                                    parent: {
                                        name: 'Skill',
                                        apiIdSingular: 'skill',
                                        apiIdPlural: 'skills',
                                        groupName: '',
                                        method: 'hasMany',
                                    },
                                    isOneToMany: false,
                                    isManyToMany: true,
                                    isChild: true,
                                    isParent: false,
                                },
                            ],
                            fields: [
                                {
                                    name: 'fullName',
                                    type: 'string',
                                    validationRules: 'required',
                                    isNullable: false,
                                },
                            ],
                        },
                    ])
                    const isLoading = ref(false)
                    const projectPath = new URLSearchParams(
                        window.location.search
                    ).get('projectPath')
                    const isVisibleTableModal = ref(false)
                    const isClickedUpdateTable = ref(false)
                    const currentTableIndex = ref(0)
                    const relationTypes = ref([
                        {
                            name: 'One to Many',
                            code: 'one-to-many',
                        },
                        {
                            name: 'Many to Many',
                            code: 'many-to-many',
                        },
                    ])
                    const tableFormState = reactive({
                        name: '',
                        apiIdSingular: '',
                        apiIdPlural: '',
                        groupName: '',
                        relations: [],
                        // relationType: null,
                        // relationTable: [],
                        fields: [],
                    })
                    const migrationTypes = ref([])
                    function toggleTableModal() {
                        isVisibleTableModal.value = !isVisibleTableModal.value
                        isClickedUpdateTable.value = false
                        tableFormState.name = ''
                        tableFormState.apiIdSingular = ''
                        tableFormState.apiIdPlural = ''
                        tableFormState.groupName = ''
                        // tableFormState.relationType = null
                        // tableFormState.relationTable = null
                        tableFormState.relations = [
                            {
                                relationType: null,
                                relationTable: null,
                            },
                        ]
                        tableFormState.fields = []
                    }

                    async function getMigrationTypes() {
                        try {
                            const res = await axios.get(
                                '/api/laravel/migration-types'
                            )
                            migrationTypes.value = res.data
                        } catch (e) {
                            console.error(e)
                        }
                    }

                    function createField() {
                        tableFormState.fields.push({
                            name: '',
                            type: null,
                            validationRules: '',
                            isNullable: false,
                        })
                    }

                    function resetField(index) {
                        tableFormState.fields[index].name = ''
                        tableFormState.fields[index].type = null
                        tableFormState.fields[index].validationRules = ''
                        tableFormState.fields[index].isNullable = false
                    }

                    function deleteField(index) {
                        tableFormState.fields.splice(index, 1)
                    }

                    function addTable() {
                        tables.value.push({ ...tableFormState })
                        for (const relation of tableFormState.relations) {
                            relation.isOneToMany =
                                relation.relationType?.code === 'one-to-many'
                            relation.isManyToMany =
                                relation.relationType?.code === 'many-to-many'
                            relation.isParent = true
                            relation.isChild = false
                            relation.parent = {
                                name: tableFormState.name,
                                apiIdSingular: tableFormState.apiIdSingular,
                                apiIdPlural: tableFormState.apiIdPlural,
                                groupName: tableFormState.groupName,
                                method: 'hasMany',
                            }
                            relation.child = {
                                name: relation.relationTable?.name,
                                apiIdSingular:
                                    relation.relationTable?.apiIdSingular,
                                apiIdPlural:
                                    relation.relationTable?.apiIdPlural,
                                groupName: relation.relationTable?.groupName,
                                method: 'belongsTo',
                            }
                            if (
                                !relation.relationTable?.relations.some(
                                    (item) =>
                                        item.relationTable?.name ===
                                        tableFormState.name
                                )
                            ) {
                                relation.relationTable?.relations.push({
                                    relationType: relation.relationType,
                                    relationTable: {
                                        name: tableFormState.name,
                                        apiIdSingular:
                                            tableFormState.apiIdSingular,
                                        apiIdPlural: tableFormState.apiIdPlural,
                                        groupName: tableFormState.groupName,
                                    },
                                    child: relation.child,
                                    parent: relation.parent,
                                    isOneToMany: relation.isOneToMany,
                                    isManyToMany: relation.isManyToMany,
                                    isChild: true,
                                    isParent: false,
                                })
                            }
                        }
                        isVisibleTableModal.value = false
                        Object.assign(tableFormState, {
                            name: '',
                            apiIdSingular: '',
                            apiIdPlural: '',
                            gropName: '',
                            relations: [
                                {
                                    relationType: null,
                                    relationTable: null,
                                },
                            ],
                            fields: [],
                        })
                    }
                    function toggleUpdateTable(index) {
                        isClickedUpdateTable.value = true
                        isVisibleTableModal.value = true
                        currentTableIndex.value = index
                        tableFormState.name = tables.value[index].name
                        tableFormState.apiIdSingular =
                            tables.value[index].apiIdSingular
                        tableFormState.apiIdPlural =
                            tables.value[index].apiIdPlural
                        tableFormState.groupName = tables.value[index].groupName
                        tableFormState.fields = tables.value[index].fields
                        tableFormState.relations = tables.value[index].relations
                    }

                    function updateTable() {
                        tables.value[currentTableIndex.value] = {
                            ...tableFormState,
                        }
                        for (const relation of tableFormState.relations) {
                            relation.isOneToMany =
                                relation.relationType?.code === 'one-to-many'
                            relation.isManyToMany =
                                relation.relationType?.code === 'many-to-many'
                            relation.parent = {
                                name: tableFormState.name,
                                apiIdSingular: tableFormState.apiIdSingular,
                                apiIdPlural: tableFormState.apiIdPlural,
                                groupName: tableFormState.groupName,
                            }
                            relation.child = {
                                name: relation.relationTable?.name,
                                apiIdSingular:
                                    relation.relationTable?.apiIdSingular,
                                apiIdPlural:
                                    relation.relationTable?.apiIdPlural,
                                groupName: relation.relationTable?.groupName,
                            }
                            relation.isParent = true
                            relation.isChild = false
                            if (
                                !relation.relationTable?.relations?.some(
                                    (item) => {
                                        return (
                                            item.relationTable?.name ===
                                            tableFormState.name
                                        )
                                    }
                                )
                            ) {
                                relation.relationTable?.relations?.push({
                                    relationType: relation.relationType,
                                    relationTable: {
                                        name: tableFormState.name,
                                        apiIdSingular:
                                            tableFormState.apiIdSingular,
                                        apiIdPlural: tableFormState.apiIdPlural,
                                        groupName: tableFormState.groupName,
                                        child: relation.child,
                                        parent: relation.parent,
                                        isOneToMany: relation.isOneToMany,
                                        isManyToMany: relation.isManyToMany,
                                        isChild: true,
                                        isParent: false,
                                    },
                                })
                            }
                        }

                        // update other tables
                        for (const table of tables.value) {
                            if (
                                table.relations?.some(
                                    (item) =>
                                        item.relationTable?.name ===
                                        tableFormState.name
                                ) &&
                                !tableFormState.relations?.some(
                                    (item) =>
                                        item.relationTable?.name === table?.name
                                )
                            ) {
                                const filtered = table.relations?.filter(
                                    (item) =>
                                        item.relationTable?.name !==
                                        tableFormState.name
                                )
                                table.relations = filtered
                            }
                        }
                        isVisibleTableModal.value = false
                        Object.assign(tableFormState, {
                            name: '',
                            apiIdSingular: '',
                            apiIdPlural: '',
                            gropName: '',
                            relations: [],
                            fields: [],
                        })
                        console.log(tables.value)
                    }

                    function deleteTable(index) {
                        // delete from other table relations
                        for (const table of tables.value) {
                            if (
                                table.relations?.some(
                                    (item) =>
                                        item.relationTable?.name ===
                                        tables.value[index]?.name
                                )
                            ) {
                                const filtered = table.relations?.filter(
                                    (item) =>
                                        item.relationTable?.name !==
                                        tables.value[index]?.name
                                )
                                table.relations = filtered
                            }
                        }
                        tables.value.splice(index, 1)
                    }

                    async function sendTables() {
                        try {
                            isLoading.value = true
                            const pivots = []
                            const pivotNames = new Set() // Set to track unique pivot names

                            for (const table of tables.value) {
                                for (const relation of table.relations) {
                                    if (relation.relationTable) {
                                        // Create pivot name in alphabetical order
                                        const pivotName = [
                                            table.apiIdSingular,
                                            relation.relationTable
                                                .apiIdSingular,
                                        ]
                                            .sort() // Alphabetically sort the two table names
                                            .join('_') // Join with underscore

                                        // Only add pivot if the name is not already in the pivotNames set
                                        if (!pivotNames.has(pivotName)) {
                                            const pivot = {
                                                name: pivotName,
                                                fields: [
                                                    {
                                                        type: 'foreignId',
                                                        title: [
                                                            table.apiIdSingular,
                                                            relation
                                                                .relationTable
                                                                .apiIdSingular,
                                                        ].sort()[0],
                                                    },
                                                    {
                                                        type: 'foreignId',
                                                        title: [
                                                            table.apiIdSingular,
                                                            relation
                                                                .relationTable
                                                                .apiIdSingular,
                                                        ].sort()[1],
                                                    },
                                                    {
                                                        type: 'primary',
                                                        title: [
                                                            [
                                                                table.apiIdSingular,
                                                                relation
                                                                    .relationTable
                                                                    .apiIdSingular,
                                                            ].sort()[0] + '_id',
                                                            [
                                                                table.apiIdSingular,
                                                                relation
                                                                    .relationTable
                                                                    .apiIdSingular,
                                                            ].sort()[1] + '_id',
                                                        ],
                                                    },
                                                ],
                                            }
                                            if (
                                                relation.relationType?.code ===
                                                'many-to-many'
                                            ) {
                                                pivots.push(pivot) // Add the pivot object to the array
                                                pivotNames.add(pivotName) // Track the pivot name to prevent duplicates
                                            }
                                        }
                                    }
                                }
                            }

                            const body = {
                                tables: tables.value,
                                pivots: pivots,
                                projectPath,
                            }

                            const res = await axios.post(
                                '/api/laravel/build-scheme',
                                body
                            )
                            isLoading.value = false
                        } catch (e) {
                            isLoading.value = false
                            console.error(e)
                        }
                    }
                    const onColReorder = () => {
                        toast.add({
                            severity: 'success',
                            summary: 'Column Reordered',
                            life: 3000,
                        })
                    }
                    const onRowReorder = (event) => {
                        products.value = event.value
                        toast.add({
                            severity: 'success',
                            summary: 'Rows Reordered',
                            life: 3000,
                        })
                    }

                    onMounted(() => {
                        getMigrationTypes()
                    })
                    return {
                        tables,
                        isVisibleTableModal,
                        isClickedUpdateTable,
                        toggleTableModal,
                        tableFormState,
                        relationTypes,
                        migrationTypes,
                        createField,
                        resetField,
                        deleteField,
                        addTable,
                        toggleUpdateTable,
                        updateTable,
                        sendTables,
                        isLoading,
                        deleteTable,
                        onColReorder,
                        onRowReorder,
                    }
                },
            })

            app.use(PrimeVue.Config, {
                theme: {
                    preset: PrimeVue.Themes.Aura,
                },
            })
            app.use(PrimeVue.ToastService)
            app.component('p-datepicker', PrimeVue.DatePicker)
            app.component('p-input', PrimeVue.InputText)
            app.component('divider', PrimeVue.Divider)
            app.component('p-button', PrimeVue.Button)
            app.component('p-dialog', PrimeVue.Dialog)
            app.component('p-select', PrimeVue.Select)
            app.component('p-table', PrimeVue.DataTable)
            app.component('p-column', PrimeVue.Column)
            app.component('p-toast', PrimeVue.Toast)
            app.component('p-toggle-switch', PrimeVue.ToggleSwitch)
            app.component('p-progress-spinner', PrimeVue.ProgressSpinner)
            // app.component('p-badge', PrimeVue.Badge)
            app.component('p-tag', PrimeVue.Tag)
            app.mount('#app')
        </script>
    </body>
</html>
